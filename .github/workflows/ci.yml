name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install
      - name: Build Web
        run: pnpm run build

  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'pnpm'
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      - name: Install NDK and SDK
        run: |
          sdkmanager "ndk;26.1.10909125" "platforms;android-36" "build-tools;35.0.0"
          yes | sdkmanager --licenses
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android, armv7-linux-androideabi, i686-linux-android, x86_64-linux-android
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libxdo-dev libssl-dev libayatana-appindicator3-dev librsvg2-dev perl make
      - name: Install dependencies
        run: pnpm install
      - name: Create dummy keystore for Android build
        run: |
          mkdir -p src-tauri/gen/android/app
          cd src-tauri/gen/android/app
          keytool -genkey -v -keystore release.jks -keyalg RSA -keysize 2048 -validity 10000 -alias android -dname "CN=Android,O=Android,C=US" -storepass android -keypass android
          echo "storeFile=release.jks" > ../keystore.properties
          echo "storePassword=android" >> ../keystore.properties
          echo "keyAlias=android" >> ../keystore.properties
          echo "keyPassword=android" >> ../keystore.properties
      - name: Build Android
        env:
          NDK_HOME: ${{ env.ANDROID_HOME }}/ndk/26.1.10909125
        run: pnpm tauri android build --target aarch64-linux-android

  build-ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'pnpm'
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios, x86_64-apple-ios, aarch64-apple-ios-sim
      - name: Install dependencies
        run: pnpm install
      - name: Fix iOS code signing (inject dummy team)
        run: |
          jq '.bundle.iOS.developmentTeam = "DUMMYTEAMID"' src-tauri/tauri.conf.json > tauri.conf.json.tmp && mv tauri.conf.json.tmp src-tauri/tauri.conf.json
      - name: Initialize iOS
        run: pnpm tauri ios init
      - name: Build iOS
        run: |
          pnpm tauri ios build --target aarch64-sim --quiet -- \
            -sdk iphonesimulator \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            PROVISIONING_PROFILE_SPECIFIER="" \
            DEVELOPMENT_TEAM="DUMMYTEAMID" \
            CODE_SIGN_STYLE=Manual
